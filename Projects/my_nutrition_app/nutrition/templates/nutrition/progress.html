{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>{% trans "Progress â€” Nutrition Helper" %}</title>
    <link rel="stylesheet" href="{% static 'nutrition/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="root">

{# use shared nav partial (replaced duplicated svg + nav) #}
{% include 'nutrition/partials/nav.html' %}

<h1>{% trans "Progress & Goals" %}</h1>

<div class="card">
    <h2>{% trans "Calories per day (last 14 days)" %}</h2>
    <canvas id="calChart" width="800" height="300"
            data-dates="{{ dates_json|escapejs }}"
            data-calories="{{ calories_json|escapejs }}"></canvas>
</div>

<script>
(function() {
    const canvas = document.getElementById('calChart');
    if(!canvas){
      console.warn('Chart canvas not found');
      return;
    }

    function showNoData(message){
      const wrap = canvas.parentElement;
      canvas.style.display = 'none';
      const el = document.createElement('div');
      el.className = 'no-data-placeholder';
      el.style.padding = '2rem';
      el.style.color = '#666';
      el.style.fontSize = '1rem';
      el.textContent = message || '{% trans "No data available for chart" %}';
      wrap.appendChild(el);
    }

    let dates = [];
    let calories = [];

    try {
        dates = JSON.parse(canvas.dataset.dates || '[]');
    } catch (e) {
        console.warn('Failed to parse dates JSON from dataset', e);
        dates = [];
    }
    try {
        calories = JSON.parse(canvas.dataset.calories || '[]');
    } catch (e) {
        console.warn('Failed to parse calories JSON from dataset', e);
        calories = [];
    }

    async function fetchFallback(){
      const url = '/nutrition/api/daily_calories/?days=14';
      try {
        const res = await fetch(url, { credentials: 'same-origin' });
        if(!res.ok) {
          console.info('Fallback API returned', res.status);
          return null;
        }
        const json = await res.json();
        if(Array.isArray(json.dates) && Array.isArray(json.calories)) return json;
        return null;
      } catch (err){
        console.info('Fallback fetch failed', err);
        return null;
      }
    }

    (async function initChart(){
      // If either array empty, try fallback once
      if((!dates || dates.length === 0) || (!calories || calories.length === 0)){
        const fallback = await fetchFallback();
        if(fallback){
          dates = fallback.dates || [];
          calories = fallback.calories || [];
        }
      }

      // If still no data, show placeholder
      if((!dates || dates.length === 0) && (!calories || calories.length === 0)){
        showNoData('{% trans "No chart data for the last 14 days." %}');
        return;
      }

      // Normalise lengths and limit to last 14 entries
      const available = Math.min(
        Math.max(dates ? dates.length : 0, 0),
        Math.max(calories ? calories.length : 0, 0)
      );
      const N = Math.min( Math.max(available, 0) || Math.max(dates.length, calories.length, 0), 14 );

      // If lengths differ, align by taking last minLen entries
      const minLen = Math.min(dates.length, calories.length) || Math.max(dates.length, calories.length);
      const take = Math.min(minLen || Math.max(dates.length, calories.length), 14);

      // Fallback: if one array longer, take last `take` from both (if one empty, use the other's last entries paired with indices)
      if(minLen > 0){
        dates = dates.slice(-take);
        calories = calories.slice(-take);
      } else {
        // If one of arrays was empty but the other had values (rare), try to pair indices
        if(dates.length && !calories.length){
          dates = dates.slice(-take);
          calories = dates.map(_ => 0); // unknown calories -> 0
        } else if(calories.length && !dates.length){
          calories = calories.slice(-take);
          // create synthetic labels (e.g. last N days)
          const labels = [];
          for(let i = 0; i < calories.length; i++){
            labels.push('{% trans "Day" %} ' + (i+1));
          }
          dates = labels.slice(-take);
        }
      }

      // final guard: if arrays still empty => placeholder
      if(!dates || !dates.length || !calories || !calories.length){
        showNoData('{% trans "No chart data for the last 14 days." %}');
        return;
      }

      // Add small note under the chart indicating how many days are shown
      (function addNote(){
        const wrap = canvas.parentElement;
        let note = wrap.querySelector('.chart-note');
        if(!note){
          note = document.createElement('div');
          note.className = 'chart-note';
          note.style.marginTop = '6px';
          note.style.color = '#666';
          note.style.fontSize = '0.9rem';
          wrap.appendChild(note);
        }
        const count = Math.min(14, dates.length);
        note.textContent = `{% trans "Showing last" %} ` + count + ` {% trans "day(s) (max 14)" %}`;
      })();

      const ctx = canvas.getContext('2d');
      new Chart(ctx, {
          type: 'bar',
          data: {
              labels: dates,
              datasets: [{
                  label: '{% trans "Calories per day" %}',
                  data: calories,
                  backgroundColor: function(context){
                    const v = context.dataset.data[context.dataIndex] || 0;
                    return v > 2500 ? 'rgba(255,99,71,0.85)' : 'rgba(76,175,80,0.7)';
                  },
                  borderColor: 'rgba(76, 175, 80, 1)',
                  borderWidth: 1,
                  borderRadius: 4
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: { color: '#666' },
                      grid: { color: '#eee' }
                  },
                  x: {
                      ticks: { color: '#666' },
                      grid: { color: '#eee' }
                  }
              },
              plugins: {
                  legend: {
                      labels: { color: '#333', font: { size: 12 } }
                  },
                  tooltip: {
                    callbacks: {
                      label: function(ctx){
                        return ctx.dataset.label + ': ' + ctx.formattedValue + ' kcal';
                      }
                    }
                  }
              }
          }
      });
    })();

})();
</script>

<div class="card" style="margin-top: 2rem; text-align: center;">
    <p style="color: #666;">ðŸ“Š {% trans "Track your daily calorie intake to monitor your progress towards your goals." %}</p>
</div>

</div><!-- #root -->
</body>
</html>
