{% load i18n %}
{% load static %}
{% load nutrition_extras %}
<!DOCTYPE html>
<html>
<head>
    <title>{% trans "Add Food — Nutrition Helper" %}</title>
    <link rel="stylesheet" href="{% static 'nutrition/style.css' %}">
</head>
<body>
<div id="root">


{% include 'nutrition/partials/nav.html' %}


<script src="{% static 'nutrition/js/common.js' %}"></script>

<!-- expose template URLs to external JS (small safe inline object) -->
<script>
  window.NUTRITION_URLS = {
    api_add_entry: "{% url 'nutrition:api_add_entry' %}",
    api_product_search: "{% url 'nutrition:api_product_search' %}",
    api_product_lookup: "{% url 'nutrition:api_product_lookup' %}"
  };
</script>



<!-- interactive form for adding custom food entries -->
<!-- improved custom form inputs: use text+inputmode to allow comma decimals -->
<form id="addCustomForm" class="card" onsubmit="return false;">
  <h1>{% trans "Add food" %}</h1>
  <label for="customName">{% trans "Product name" %}:</label>
  <input id="customName" type="text" placeholder="{% trans 'e.g. Homemade granola' %}" style="width:100%; padding:0.6rem; border-radius:6px; border:1px solid var(--border-color);">

  <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:0.6rem; margin-top:0.6rem;">
    <div>
      <label for="kcal100">{% trans "Calories (per 100g)" %}</label>
      <input id="kcal100" type="number" min="0" step="any" placeholder="kcal" style="width:100%; padding:0.45rem; border-radius:6px; border:1px solid var(--border-color);">
    </div>
    <div>
      <label for="protein100">{% trans "Protein (g/100g)" %}</label>
      <input id="protein100" type="number" min="0" step="any" placeholder="g" style="width:100%; padding:0.45rem; border-radius:6px; border:1px solid var(--border-color);">
    </div>
    <div>
      <label for="fat100">{% trans "Fat (g/100g)" %}</label>
      <input id="fat100" type="number" min="0" step="any" placeholder="g" style="width:100%; padding:0.45rem; border-radius:6px; border:1px solid var(--border-color);">
    </div>
    <div>
      <label for="carbs100">{% trans "Carbs (g/100g)" %}</label>
      <input id="carbs100" type="number" min="0" step="any" placeholder="g" style="width:100%; padding:0.45rem; border-radius:6px; border:1px solid var(--border-color);">
    </div>
  </div>

  <label for="amountGr" style="margin-top:0.8rem;">{% trans "Amount (grams)" %}:</label>
  <input id="amountGr" name="amount" type="number" min="1" step="any" value="100" style="width:140px; padding:0.45rem; border-radius:6px; border:1px solid var(--border-color);">

  <div id="customPreview" style="display:none; margin-top:0.8rem; color:#444;">
    <div><strong id="pvName"></strong> — <span id="pvWeight"></span></div>
    <div id="pvKcal" style="margin-top:0.3rem;"></div>
    <div id="pvMacros" style="margin-top:0.25rem; color:#666;"></div>
  </div>

  <div style="margin-top:0.9rem;">
    <button id="submitCustom" class="btn btn-primary">{% trans "Add custom product" %}</button>
    <button id="clearCustom" type="button" class="btn btn-outline" style="margin-left:0.6rem;">{% trans "Clear" %}</button>
    <span id="customMsg" style="margin-left:0.8rem; color:#666;"></span>
  </div>
</form>

<hr>

<!-- summary header: 'Съедено за сегодня' (inline stats) -->
<div class="summary-header-wrap" style="max-width:980px; margin:0.25rem auto;">
  <div class="summary-header">
    <div class="summary-left" style="display:flex; flex-direction:column; gap:8px; flex:1;">
      <div class="summary-title">{% trans "Eaten today" %}</div>

      <!-- inline stats row (only final values shown) -->
      <div class="summary-values" role="list" aria-label="{% trans 'Today totals' %}">
        <div class="summary-value" role="listitem">
            <span class="sv-label">{% trans "Calories" %}</span>
          <div class="sv-value" aria-live="polite">
            <span id="totCalories" style="font-weight:800; font-size:1.1rem;">{{ totals.calories }}</span>
            <span class="sv-unit" style="margin-left:0.5rem;">kcal</span>
          </div>
        </div>

        <div class="summary-value" role="listitem">
          <span class="sv-label">{% trans "Protein" %}</span>
          <div class="sv-value" aria-live="polite">
            <span id="totProtein" style="font-weight:800; font-size:1.1rem;">{{ totals.protein }}</span>
            <span class="sv-unit" style="margin-left:0.5rem;">g</span>
          </div>
        </div>

        <div class="summary-value" role="listitem">
          <span class="sv-label">{% trans "Fat" %}</span>
          <div class="sv-value" aria-live="polite">
            <span id="totFat" style="font-weight:800; font-size:1.1rem;">{{ totals.fat }}</span>
            <span class="sv-unit" style="margin-left:0.5rem;">g</span>
          </div>
        </div>

        <div class="summary-value" role="listitem">
          <span class="sv-label">{% trans "Carbs" %}</span>
          <div class="sv-value" aria-live="polite">
            <span id="totCarbs" style="font-weight:800; font-size:1.1rem;">{{ totals.carbs }}</span>
            <span class="sv-unit" style="margin-left:0.5rem;">g</span>
          </div>
        </div>
      </div>
    </div>

    <!-- eat progress (unchanged) -->
    <div id="eatProgress" class="eat-progress" data-eaten="{{ totals.calories|default:0 }}" data-rec="{{ recommendation.recommended_kcal|default:'0' }}" aria-hidden="false" style="max-width:260px;">
      <div class="eat-meta" style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
        <div style="font-size:0.9rem; color:#666; font-weight:600;">{% trans "Progress" %}</div>
        <div id="eatPercent" style="font-weight:800; color:var(--primary-color);">0%</div>
      </div>
      <div class="eat-bar-wrap" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="margin-top:6px;">
        <div class="eat-bar" style="width:0%;"></div>
      </div>
      <div class="eat-values" style="font-size:0.85rem; color:#666; margin-top:6px;">0 / 0 kcal</div>
    </div>
  </div>
</div>

<!-- interactive form for adding custom food entries -->
<div class="card" style="margin-top: 1rem;">
    <h2 class="entries-title" style="display:flex; align-items:center; gap:1rem; margin:0 0 0.6rem 0;">
      <span>{% trans "Entries today" %}</span>
      <small class="entries-date" style="color:#666; font-weight:600;">— {% now "j F Y" %}</small>
    </h2>

        {# Always render the UL so JS can insert entries even when server-side list is empty #}
        <ul id="entriesList" style="list-style:none; padding:0; margin:0;">
            {% if entries %}
                {% for e in entries %}
                <li style="padding:0.6rem 0; border-bottom:1px solid var(--border-color)"
                    data-entry-id="{{ e.pk }}"
                    data-kcal="{{ e.kcal|floatformat:2 }}"
                    data-protein="{{ e.protein|floatformat:2 }}"
                    data-fat="{{ e.fat|floatformat:2 }}"
                    data-carbs="{{ e.carbs|floatformat:2 }}">
                  <div class="entry-row">
                    <div style="min-width:160px;">
                        <strong class="entry-name">{{ e.name }}</strong>
                        <div style="color:#666; font-size:0.95rem;">
                            <div style="margin-bottom:0.3rem;">
                              {% if e.initial_amount and e.initial_amount != e.amount %}
                                <span class="entry-amount-initial" style="text-decoration:line-through; opacity:0.6;">{{ e.initial_amount|floatformat:1 }}g</span>
                                → <strong class="entry-amount-current">{{ e.amount|floatformat:1 }}g</strong>
                              {% else %}
                                <strong class="entry-amount-current">{{ e.amount|floatformat:1 }}g</strong>
                              {% endif %}
                            </div>
                            <span style="color:var(--primary-color);"><span class="entry-kcal">{{ e.kcal|floatformat:2 }}</span> kcal</span>
                            • <span class="entry-protein">{{ e.protein|floatformat:2 }}</span> g protein
                            • <span class="entry-fat">{{ e.fat|floatformat:2 }}</span> g fat
                            • <span class="entry-carbs">{{ e.carbs|floatformat:2 }}</span> g carbs
                        </div>
                    </div>

                    <!-- action stickers -->
                    <div class="entry-controls">
                      <div class="entry-actions" data-entry-id="{{ e.pk }}">
                        <button type="button" class="sticker sticker--edit" aria-label="{% trans 'Edit entry' %}" title="{% trans 'Edit' %}" data-action="toggle-edit">
                          <!-- pencil icon -->
                          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></svg>
                        </button>

                        <button type="button" class="sticker sticker--delete" aria-label="{% trans 'Delete entry' %}" title="{% trans 'Delete' %}" data-action="delete">
                          <!-- trash icon -->
                          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- hidden edit/delete forms for server-side FoodEntry and for custom Entry (server handlers accept both) -->
                  {% if e.origin == 'food' or e.origin == 'entry' %}
                  <div id="edit-form-{{ e.pk }}" class="entry-edit-form" aria-hidden="true">
                    <form action="{% url 'nutrition:edit_entry' e.pk %}" method="post" class="edit-form-inline">
                        {% csrf_token %}
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                          <label for="edit-amount-{{ e.pk }}" style="margin:0 0.5rem 0 0; color:#444;">{% trans "Amount (g)" %}</label>
                          <input id="edit-amount-{{ e.pk }}" name="amount" type="text" inputmode="decimal" step="0.1" min="0.1" value="{{ e.amount }}" style="width:110px; padding:0.45rem; border-radius:6px; border:1px solid var(--border-color);">
                          <button type="submit" class="btn btn-primary" style="padding:0.45rem 0.8rem;">{% trans "Save" %}</button>
                          <button type="button" class="btn btn-outline" data-action="cancel-edit" style="padding:0.45rem 0.8rem;">{% trans "Cancel" %}</button>
                        </div>
                    </form>
                    <form id="delete-form-{{ e.pk }}" action="{% url 'nutrition:delete_entry' e.pk %}" method="post" style="display:none;">
                      {% csrf_token %}
                    </form>
                  </div>
                  {% endif %}
                </li>
                {% endfor %}
            {% else %}
                <li class="no-entries" style="padding:0.8rem 0; color:#999; text-align:center;">{% trans "No entries" %}</li>
            {% endif %}
        </ul>
</div>

<!-- Product search via external API (search + barcode lookup) -->
<div class="card" style="max-width:980px; margin: 1rem auto;">
  <h3>{% trans "Search product (external database)" %}</h3>

  <!-- free-text search (existing) -->
  <div style="display:flex; gap:0.5rem; align-items:center; margin-bottom:0.75rem;">
    <!-- accessible label for search (visually hidden) -->
    <label for="apiSearchInput" style="position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;">
      {% trans "Search products" %}
    </label>
    <input id="apiSearchInput" name="q" type="search" placeholder="{% trans 'Search products (e.g. banana, milk)' %}" style="flex:1; padding:0.6rem; border-radius:6px; border:1px solid var(--border-color);">
    <button id="apiSearchBtn" class="btn btn-outline">{% trans "Search" %}</button>
  </div>

  <!-- barcode lookup -->
  <div style="display:flex; gap:0.5rem; align-items:center;">
    <!-- accessible label for barcode input (visually hidden) -->
    <label for="apiBarcodeInput" style="position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;">
      {% trans "Barcode" %}
    </label>
    <input id="apiBarcodeInput" name="barcode" type="text" placeholder="{% trans 'Enter UPC / Barcode (e.g. 012345678905)' %}" style="flex:0.6; padding:0.6rem; border-radius:6px; border:1px solid var(--border-color);">
    <button id="apiBarcodeBtn" class="btn btn-outline">{% trans "Lookup by barcode" %}</button>
    <div style="flex:1; color:#666; font-size:0.9rem;">{% trans "Or search by name using the field above." %}</div>
  </div>

  <div id="apiResults" style="margin-top:1rem;"></div>
 
</div>

</div>


<script src="{% static 'nutrition/js/home.js' %}"></script>

</body>
</html>
